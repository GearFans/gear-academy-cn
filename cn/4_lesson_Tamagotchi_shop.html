<html lang="zh-CN" class="translated-ltr"><head>
  <base href="https://108.ufo.k0s.io/4_lesson_Tamagotchi_shop.md"> 
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      document.title = window.location.hostname;
    });
  </script> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <style>
    body {
      font-family: "Arial", sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      font-size: 2rem;
      color: #222;
      margin-bottom: 10px;
    }

    h1 a {
      color: #222;
      text-decoration: none;
    }

    a {
      color: #2a7ae2;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    p {
      margin-bottom: 20px;
    }

    hr {
      border: 0;
      border-top: 1px solid #eee;
      margin: 20px 0;
    }

    table {
      border-collapse: collapse;
      width: 50%;
    }

    th, td {
      border: 1px solid black;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }
  </style> 
  <meta http-equiv="X-Translated-By" content="Google">
  <meta http-equiv="X-Translated-To" content="zh-CN">
  <script type="text/javascript" src="https://www.gstatic.com/_/translate_http/_/js/k=translate_http.tr.en_US.WYPRFnOi8do.O/d=1/rs=AN8SPfpuhFJPZIC1bAeelVoE7UV7Vt-MPA/m=corsproxy" data-sourceurl="https://108.ufo.k0s.io/4_lesson_Tamagotchi_shop.md" data-navigation-history-proxy-enabled="true"></script>
  <meta name="robots" content="none">
 <script async="" src="https://www.gstatic.com/feedback/js/help/prod/service/lazy.min.js"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="https://www.gstatic.com/_/translate_http/_/ss/k=translate_http.tr.69JJaQ5G5xA.L.W.O/d=0/rs=AN8SPfpC36MIoWPngdVwZ4RUzeJYZaC7rg/m=el_main_css"><script type="text/javascript" charset="UTF-8" src="https://translate.googleapis.com/_/translate_http/_/js/k=translate_http.tr.zh_CN.vP9ARk0hD0A.O/d=1/exm=el_conf/ed=1/rs=AN8SPfr7Qhi-OTQKbFnpEq_vjdvjiKNGqA/m=el_main"></script><title>108-飞碟-k0s-io.translate.goog</title></head> 
 <body style="margin-top: 56px;">
  <script type="text/javascript" src="https://www.gstatic.com/_/translate_http/_/js/k=translate_http.tr.en_US.WYPRFnOi8do.O/d=1/exm=corsproxy/ed=1/rs=AN8SPfpuhFJPZIC1bAeelVoE7UV7Vt-MPA/m=navigationui" data-environment="prod" data-proxy-url="https://108-ufo-k0s-io.translate.goog" data-proxy-full-url="https://108-ufo-k0s-io.translate.goog/4_lesson_Tamagotchi_shop.md?_x_tr_sl=en&amp;_x_tr_tl=zh-CN&amp;_x_tr_hl=zh-CN&amp;_x_tr_pto=wapp" data-source-url="https://108.ufo.k0s.io/4_lesson_Tamagotchi_shop.md" data-source-language="en" data-target-language="zh-CN" data-display-language="zh-CN" data-detected-source-language="" data-is-source-untranslated="false" data-source-untranslated-url="https://translate.google.com/website?sl=en&amp;tl=zh-CN&amp;hl=zh-CN&amp;client=webapp&amp;u=https://108.ufo.k0s.io/4_lesson_Tamagotchi_shop.md&amp;anno=2" data-use-in-place-translation="true" data-client="webapp"></script> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第 4 课：Tamagotchi 商店说明</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">课程总结：</font></font></p> 
  <ul> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本课程涵盖如何使用可替代代币创建销售电子鸡的合约。</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamagotchi 可以具有各种属性，例如配饰、服装和武器，这将是我们即将推出的 Tamagotchi 对战游戏所必需的。</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要购买属性，Tamagotchi 的余额中必须有足够的代币，并且它必须批准商店转让其代币的合同。</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们将探讨事务处理以及如何处理在执行过程中出现错误的事务。</font></font></p> </li> 
  </ul> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">课程目标：</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在本课结束时，用户将：</font></font></p> 
  <ul> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建使用可替代代币销售电子宠物的合约</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">连接可替代代币的概念（来自第 3 课）及其在购买 Tamagotchi 属性中的用途</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">了解如何检查 Tamagotchi 代币余额并批准转移代币的合同。</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">了解如何处理未完成的交易</font></font></p> </li> 
  </ul> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们开始吧！</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">购买过程包括三个步骤：</font></font></p> 
  <ol> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamagotchi 向可替代代币合约发送一条消息，以批准商店合约转移其代币；</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamagotchi 向商店合约发送消息，表明它想要购买的属性；</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">商店合约向可替代代币合约发送一条消息，以将代币转移给自己。</font><font style="vertical-align: inherit;">如果代币成功转移，商店会将属性添加到 Tamagotchi 属性中。</font></font></p> </li> 
  </ol> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[图像占位符]</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编码</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们开始编写智能合约。</font><font style="vertical-align: inherit;">首先，我们将定义商店合约状态的结构：</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[代码占位符]</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们将使用类型别名来提高代码的可读性：</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[代码占位符]</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">属性的元数据包含以下字段：</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[代码占位符]</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们定义商店合约必须执行的操作：</font></font></p> 
  <ul> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">合约必须创建新的属性并将它们出售给 Tamagotchi 合约；</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">合约必须接收来自 Tamagotchi 合约的消息。</font></font></p> </li> 
  </ul> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在实现这些功能之前，我们将定义合约商店的 store-io crate 并编写 lib.rs 文件：</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[代码占位符]</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">商店合约将接受两种类型的消息：CreateAttribute 和 BuyAttribute。</font><font style="vertical-align: inherit;">消息执行成功后，它会回复 AttributeCreated 或 AttributeSold。</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后我们将编写程序的基本结构如下：</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[代码占位符]</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buy_attribute 函数是异步的，因为商店合约必须向代币合约发送消息并等待它的回复。</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在，让我们实现 create_attribute 函数。</font><font style="vertical-align: inherit;">这个函数很简单，执行以下步骤：</font></font></p> 
  <ul> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">验证发送消息的帐户是合约管理员。</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">确保具有指定 ID 的属性不存在。</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建一个新属性</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发送一个回复，指示属性创建成功。</font></font></p> </li> 
  </ul> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[代码占位符]</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接下来，让我们深入了解 buy_attribute 函数的实现。</font><font style="vertical-align: inherit;">正如我们之前讨论的，此函数负责启动从 Tamagotchi 合约到商店合约的代币转移，并且它必须跟踪可替代代币合约中的交易 ID。</font><font style="vertical-align: inherit;">为此，我们将在商店合约的状态中添加一个名为 transaction_id 的新字段。</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">因此，商店合约负责跟踪可替代代币中的交易，并且必须考虑其中当前交易的 ID。</font><font style="vertical-align: inherit;">让我们将字段 transaction_id 添加到合约状态：</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[代码占位符]</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该字段将存储当前交易的 ID，并允许商店合约轻松跟踪代币转移的状态。</font><font style="vertical-align: inherit;">有了这个字段，buy_attribute 函数可以启动代币转移，跟踪交易的 ID，并等待可替代代币合约的回复以确认转移成功。</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们还在 store-io 箱子中声明交易 ID 的类型：</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[代码占位符]</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接下来，让我们假设以下情况：</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[图像占位符]</font></font></p> 
  <ol> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamagotchi 向商店合约发送消息以购买属性；</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">商店合约向同质代币合约发送消息，并收到代币转移成功的回复；</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">商店合同开始改变其状态。</font><font style="vertical-align: inherit;">它将指示的属性添加到 Tamagotchi 所有权，但耗尽了气体。</font></font></p> </li> 
  </ol> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这种情况下，代币被转移到商店合约，但 Tamagotchi 没有收到它的属性。</font><font style="vertical-align: inherit;">为防止这种情况，商店合约必须检测交易何时未完成并相应地继续执行。</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们向 AttributeStore 结构添加另一个字段：</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[代码占位符]</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当商店合约收到来自 Tamagotchi 的购买消息时，它会检查 Tamagotchi 是否已经参与任何未完成的交易。</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果 Tamagotchi 有未完成的交易，商店合约会检索与交易关联的交易编号和属性 ID，并恢复交易。</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果之前的消息没有完成，Tamagotchi 必须发送另一条相同的消息来完成交易。</font><font style="vertical-align: inherit;">但是，Tamagotchi 可能会发送多条购买消息而没有注意到某些消息未通过。</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为了处理这个问题，存储合约检查当前消息中指定的属性 ID，并将其与存储在事务中的属性 ID 进行比较。</font><font style="vertical-align: inherit;">如果保存的 id 不等于指定的 id，则商店合约会要求 Tamagotchi 完成之前的交易。</font><font style="vertical-align: inherit;">否则，它将继续挂起的事务。</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果 Tamagotchi 没有未决交易，则存储合约会增加 transaction_id 并保存交易。</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[代码占位符]</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请注意，您必须将 CompletePrevTx 事件添加到 StoreEvent 以确保正确的事件跟踪。</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们编写出售属性的函数。</font><font style="vertical-align: inherit;">出售属性类似于执行 NFT 转移。</font><font style="vertical-align: inherit;">我们会将属性 ID 分配给 Tamagotchi 合约。</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">首先，我们将编写令牌传输函数：</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[代码占位符]</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们已经向令牌合约发送了一条消息并处理了它的回复。</font><font style="vertical-align: inherit;">只有在收到 FTokenEvent::Ok 时，合约才认为发送给代币合约的消息已成功处理。</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在，我们准备编写出售属性的函数：</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[代码占位符]</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">首先，合约接收到属性价格，然后调用函数 transfer_tokens。</font><font style="vertical-align: inherit;">如果令牌传输的结果是成功的，它会将属性添加到 Tamagotchi 合约中。</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">伟大的！</font><font style="vertical-align: inherit;">我们完成了合约逻辑的编写。</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在，您应该让您的电子宠物购买属性。</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们学到了什么：</font></font></p> 
  <ul> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与可替代代币合约进行通信；</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何处理不完整/不完善的交易。</font></font></p> </li> 
  </ul> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">家庭作业：</font></font></p> 
  <ul> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将代币提供给您的 Tamagotchi 合约（此处必须是部署在测试网上的可替代代币合约的链接）；</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">向 Tamagotchi 合约添加字段以存储可替代代币合约的地址；</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加批准转移其代币的能力（以及相应的用于与可替代代币合约通信的字段 transaction_id）；</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将函数 buy_attribute 添加到你的 Tamagotchi 合约中；</font></font></p> </li> 
   <li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为您的电子宠物购买属性，看看它是如何变化的。</font></font></p> </li> 
  </ul> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对于与前端一致的合同，元数据必须如下：</font></font></p> 
  <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[代码占位符]</font></font></p>  
  <script>function gtElInit() {var lib = new google.translate.TranslateService();lib.translatePage('en', 'zh-CN', function () {});}</script>
  <script src="https://translate.google.com/translate_a/element.js?cb=gtElInit&amp;hl=zh-CN&amp;client=wt" type="text/javascript"></script><div id="goog-gt-" class="skiptranslate VIpgJd-yAWNEb-L7lbkb" dir="ltr"><div style="padding: 8px;"><div><div class="VIpgJd-yAWNEb-l4eHX"><img src="https://www.gstatic.com/images/branding/product/1x/translate_24dp.png" width="20" height="20" alt="Google 翻译"></div></div></div><div style="padding: 8px; float: left; width: 100%;"><h1 class="VIpgJd-yAWNEb-r4nke VIpgJd-yAWNEb-mrxPge">原文</h1></div><div style="padding: 8px;"><div class="VIpgJd-yAWNEb-nVMfcd-fmcmS"></div></div><div class="VIpgJd-yAWNEb-cGMI2b" style="padding: 8px;"><div class="VIpgJd-yAWNEb-Z0Arqf-PLDbbf"><span class="VIpgJd-yAWNEb-Z0Arqf-hSRGPd">提供更好的翻译建议</span></div><div class="VIpgJd-yAWNEb-fw42Ze-Z0Arqf-haAclf"><hr style="color: #ccc; background-color: #ccc; height: 1px; border: none;"><div class="VIpgJd-yAWNEb-Z0Arqf-H9tDt"></div></div></div><div class="VIpgJd-yAWNEb-jOfkMb-Ne3sFf" style="display: none;"></div></div>
 
</body></html>
